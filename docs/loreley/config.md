# loreley.config

Centralised configuration for the Loreley application, backed by `pydantic-settings` and environment variables.

## Settings

- **`Settings`**: `BaseSettings` subclass that loads core application configuration.
  - **Environment**: `app_name`, `environment`, `log_level`. `log_level` controls the global Loguru log level used across long-running processes (including the scheduler, workers, and their CLI wrappers); see the scripts documentation under `docs/script` for concrete examples.
  - **OpenAI-compatible API**: `OPENAI_API_KEY`, `OPENAI_BASE_URL` configure the API key and base URL for all OpenAI-compatible LLM and embedding calls, used by `loreley.core.map-elites.code_embedding.CodeEmbedder`, `loreley.core.map-elites.summarization_embedding.SummaryEmbedder`, and `loreley.core.worker.commit_summary.CommitSummarizer`. When unset, the OpenAI Python client falls back to its own environment variable defaults.
  - **Database**: either a raw `DATABASE_URL` or individual `DB_*` fields (scheme, host, port, username, password, database name, pool options, echo flag).
  - **Metrics**: `metrics_retention_days` controls how long metrics are retained.
  - **Task queue**: `TASKS_REDIS_URL`, `TASKS_REDIS_HOST`, `TASKS_REDIS_PORT`, `TASKS_REDIS_DB`, `TASKS_REDIS_PASSWORD`, `TASKS_REDIS_NAMESPACE`, `TASKS_QUEUE_NAME`, `TASKS_WORKER_MAX_RETRIES`, and `TASKS_WORKER_TIME_LIMIT_SECONDS` configure the Dramatiq Redis broker connection details, logical namespace, queue routing, retry policy, and actor time limits used by `loreley.tasks.broker` and `loreley.tasks.workers`. When `TASKS_REDIS_URL` is set and includes credentials, only a sanitised `scheme://host:port/db` form is logged, never the raw URL or password. `TASKS_WORKER_TIME_LIMIT_SECONDS` is interpreted in seconds and converted to Dramatiq's millisecond `time_limit`: values `<= 0` disable the time limit (no hard cap on actor runtime), while positive values enforce a per-job wall-clock limit.
  - **Scheduler**: `SCHEDULER_REPO_ROOT`, `SCHEDULER_POLL_INTERVAL_SECONDS`, `SCHEDULER_MAX_UNFINISHED_JOBS`, `SCHEDULER_SCHEDULE_BATCH_SIZE`, `SCHEDULER_DISPATCH_BATCH_SIZE`, and `SCHEDULER_INGEST_BATCH_SIZE` drive `loreley.scheduler.main`. These options determine which git worktree the scheduler inspects, how often it runs a reconciliation tick, how many unfinished jobs are allowed at once, how aggressively it samples new MAP-Elites jobs per tick, how many pending jobs are dispatched to Dramatiq each cycle, and how many completed jobs are ingested back into the archive per tick.
  - **Worker repository**: `WORKER_REPO_REMOTE_URL`, `WORKER_REPO_BRANCH`, `WORKER_REPO_WORKTREE`, `WORKER_REPO_GIT_BIN`, `WORKER_REPO_FETCH_DEPTH`, `WORKER_REPO_CLEAN_EXCLUDES`, `WORKER_REPO_JOB_BRANCH_PREFIX`, `WORKER_REPO_ENABLE_LFS`, and `WORKER_REPO_JOB_BRANCH_TTL_HOURS` configure the git worktree used by worker processes (upstream remote and branch, local checkout path, git binary, shallow clone depth, clean exclusions, job branch naming, optional Git LFS support, and how long remote job branches are retained before pruning), used by `loreley.core.worker.repository.WorkerRepository`.
  - **Worker planning**: `WORKER_PLANNING_*` options configuring how the external Codex CLI planner is invoked (binary path, optional profile, maximum attempts, timeout, extra environment variables, and an optional JSON schema override), used by `loreley.core.worker.planning.PlanningAgent`.
  - **Worker coding**: `WORKER_CODING_*` options configuring how the external Codex-based coding agent is invoked (binary path, optional profile, maximum attempts, timeout, extra environment variables, and an optional JSON schema override), used by `loreley.core.worker.coding.CodingAgent`.
  - **Worker evaluator**: `WORKER_EVALUATOR_PLUGIN`, `WORKER_EVALUATOR_PYTHON_PATHS`, `WORKER_EVALUATOR_TIMEOUT_SECONDS`, and `WORKER_EVALUATOR_MAX_METRICS` configure the evaluation plugin entry point, additional Python paths, subprocess timeout, and the maximum number of metrics to keep, used by `loreley.core.worker.evaluator.Evaluator`.
  - **Worker evolution commits**: `WORKER_EVOLUTION_COMMIT_MODEL`, `WORKER_EVOLUTION_COMMIT_TEMPERATURE`, `WORKER_EVOLUTION_COMMIT_MAX_OUTPUT_TOKENS`, `WORKER_EVOLUTION_COMMIT_MAX_RETRIES`, `WORKER_EVOLUTION_COMMIT_RETRY_BACKOFF_SECONDS`, `WORKER_EVOLUTION_COMMIT_AUTHOR`, `WORKER_EVOLUTION_COMMIT_EMAIL`, and `WORKER_EVOLUTION_COMMIT_SUBJECT_MAX_CHARS` configure how the evolution worker generates and records commit subjects (LLM model, sampling behaviour, retry policy, and subject length) and which author identity is used when creating commits, used by `loreley.core.worker.commit_summary.CommitSummarizer` and `loreley.core.worker.repository.WorkerRepository`.
  - **Map-Elites preprocessing**: `MAPELITES_PREPROCESS_*` options controlling which changed code files are considered for feature extraction (limits on file count/size, allowed extensions/filenames, excluded path globs, whitespace handling, and comment stripping), used by `loreley.core.map-elites.preprocess.CodePreprocessor`.
  - **Map-Elites chunking**: `MAPELITES_CHUNK_*` options controlling how preprocessed files are split into chunks (target and minimum lines per chunk, overlap, maximum chunks per file, and boundary keywords used by the chunker), used by `loreley.core.map-elites.chunk.CodeChunker`.
  - **Map-Elites code embedding**: `MAPELITES_CODE_EMBEDDING_*` options configuring the embedding model, optional output dimensions, batch size, per-commit chunk budget, retry count, and exponential backoff for embedding requests, used by `loreley.core.map-elites.code_embedding.CodeEmbedder`.
  - **Map-Elites summary embedding**: `MAPELITES_SUMMARY_*` and `MAPELITES_SUMMARY_EMBEDDING_*` options configuring the LLM summary model (name, temperature, max output tokens, source excerpt character limit, retries, and backoff) and the summary embedding model (name, dimensions, and batch size), used by `loreley.core.map-elites.summarization_embedding.SummaryEmbedder`.
  - **Map-Elites dimensionality reduction**: `MAPELITES_DIMENSION_REDUCTION_*` options controlling how penultimate code/summary embeddings are normalised, the target feature dimensions, minimum sample count for fitting PCA, rolling history size, and refit cadence, used by `loreley.core.map-elites.dimension_reduction.DimensionReducer`.
  - **Map-Elites feature bounds and archive**: `MAPELITES_FEATURE_*` and `MAPELITES_ARCHIVE_*` options defining the search space for behaviour features (lower/upper bounds) and the grid resolution and learning parameters for the underlying MAP-Elites archive, used by `loreley.core.map-elites.map-elites.MapElitesManager`.
  - **Map-Elites fitness and sampling**: `MAPELITES_FITNESS_*` and `MAPELITES_SAMPLER_*` options that configure which metric to optimise, how to treat fitness direction/floor, and how new jobs are drawn from the archive (inspiration count, neighbour radius, fallback sampling, default priority, and whether to include metadata), used by `loreley.core.map-elites.map-elites.MapElitesManager` and `loreley.core.map-elites.sampler.MapElitesSampler`.
- **`database_dsn`**: computed property that returns a SQLAlchemy-compatible DSN, preferring `DATABASE_URL` when set and otherwise building one from the individual DB fields (with credentials URL-encoded).
- **`export_safe()`**: helper that returns a dict of non-sensitive configuration values suitable for logging.

## Access helpers

- **`get_settings()`**: cached factory that instantiates `Settings`, logs a concise summary of the environment and DB host using `rich`/`loguru`, and returns a singleton instance for reuse across the loreley.
